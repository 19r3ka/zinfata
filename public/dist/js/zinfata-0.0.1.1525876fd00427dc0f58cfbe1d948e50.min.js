function FileDataObject(e){var t=new FormData;return angular.forEach(e,function(e,a){t.append(a,e)}),t}var app=angular.module("zinfataClient",["dispatcher","ngRoute","ngResource","ngMessages","ngImgCrop"]),dispatch=angular.module("dispatcher",[]);app.constant("ROUTES",{loginEndpoint:"zinfataclient",serverHost:"XXXXX"}).constant("AUTH",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",mustLogIn:"auth-log-in-first",logoutSuccess:"auth-logout-success",logoutFailed:"auth-logout-failed",sessionTimeout:"auth-session-timeout",authenticated:"auth-authenticated",notAuthenticated:"auth-not-authenticated",authorized:"auth-authorized",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{admin:"admin",artist:"artist",guest:"guest"}).constant("PWD_TOKEN",{sendSuccess:"token-sent-success",sendFailed:"token-sent-failed",verificationSuccess:"token-verification-success",verificationFailed:"token-verification-failed"}).constant("USER_EVENTS",{updateSuccess:"user-update-success",updateFailed:"user-update-failed",createSuccess:"user-creation-success",createFailed:"user-creation-failed",accountActivated:"user-account-activated",accountNotActivated:"user-account-not-activated",deleteSuccess:"user-delete-success",deleteFailed:"user-delete-failed"}).constant("ALBUM_EVENTS",{createSuccess:"album-creation-success",createFailed:"album-creation-failed",updateSuccess:"album-update-success",updateFailed:"album-update-failed",deleteSuccess:"album-delete-success",deleteFailed:"album-delete-failed"}).constant("TRACK_EVENTS",{updateSuccess:"track-update-success",updateFailed:"track-update-failed",createSuccess:"track-creation-success",createFailed:"track-creation-failed",deleteSuccess:"track-delete-success",deleteFailed:"track-delete-failed",downloadSuccess:"track-download-success",downloadFailed:"track-download-failed"}).constant("PLAYLIST_EVENTS",{updateSuccess:"playlist-update-success",updateFailed:"playlist-update-failed",createSuccess:"playlist-creation-success",createFailed:"playlist-creation-failed",deleteSuccess:"playlist-delete-success",deleteFailed:"playlist-delete-failed"}).constant("QUEUE",{next:"queue-next-track",prev:"queue-previous-track"}).constant("AUDIO",{set:"audio-set",playPause:"audio-play-pause",playing:"audio-playing",paused:"audio-paused",ended:"audio-ended"}),app.directive("uniqueHandle",["Users","$q","$log","$filter",function(e,t,a,r){return{require:"ngModel",link:function(a,n,o,c){var s=[],u="";e.query(function(e){for(i=0;i<e.length;i++)u=r("lowercase")(e[i].handle),s.push(u);c.$asyncValidators.uniquehandle=function(e,a){var n=t.defer(),i=r("lowercase")(e);return-1===s.indexOf(i)?n.resolve():n.reject(),n.promise}})}}}]).directive("uniqueEmail",["Users","$q","$log","$filter",function(e,t,a,r){return{require:"ngModel",link:function(a,n,o,c){var s=[];e.query(function(e){for(i=0;i<e.length;i++)s.push(r("lowercase")(e[i].email));c.$asyncValidators.uniqueemail=function(e,a){var n=t.defer(),i=r("lowercase")(e);return-1===s.indexOf(i)?n.resolve():n.reject(),n.promise}})}}}]).directive("zMatch",["$log",function(e){return{require:"ngModel",scope:{firstPassword:"=zMatch"},link:function(e,t,a,r){r.$validators.pwmatch=function(t,a){return t===e.firstPassword}}}}]).directive("zDropdown",["$document","$window",function(e,t){return{restrict:"A",link:function(a,r,n){var i=e.getElementByClassName("z-dropdown-menu");a.toggleContent=function(){i.classList.toggle("z-show")},t.onclick=function(e){e.target.matches("z-dropdown-toggle")||i.classList.contains("z-show")&&i.classList.remove("z-show")}}}}]).directive("zPlayer",["$rootScope","QueueSvc","QUEUE","AUDIO","$log","AuthenticationSvc","AUTH","MessageSvc",function(e,t,a,r,n,i,o,c){return{restrict:"E",link:function(a,n,s,u){function l(){var e=h.currentTime,t=h.duration;a.currentTime=e;var r=Math.floor(100*e/t);v.value=r,a.$apply()}function d(){h.currentTime=v.value*h.duration/100,a.$apply()}function f(){h.volume=k.value/100,a.$apply(),console.log(h.volume)}i.isAuthenticated()&&a.track&&a.track.streamUrl||n.hide(),a.$watch(function(){return i.isAuthenticated()&&a.track&&!!a.track.streamUrl},function(e,t){e?n.show():n.hide()}),a.playing=!1,a.currentTime=0,a.isLoggedIn=i.isAuthenticated;var p=document.getElementById("expand-player-controllers"),g=document.getElementById("compress-player-controllers"),m=document.getElementById("z-player-bottom");window.addEventListener("resize",function(){document.documentElement.clientWidth>=598&&m.className.match(/\s*expand-mobile/g)&&(m.className=m.className.replace(/expand-mobile/g,""))}),p.addEventListener("click",function(){m.className.match(/\s+expand-mobile/)||(m.className+="expand-mobile")}),g.addEventListener("click",function(){console.log(m.className),m.className.match(/\s*expand-mobile/)&&(m.className=m.className.replace(/expand-mobile/g,""))});var h=document.createElement("audio");h.volume=.5;var v=document.getElementById("track-duration-slider"),k=document.getElementById("player-volume-slider");h.addEventListener("play",function(){e.$broadcast(r.playing,a.track)}),h.addEventListener("pause",function(){e.$broadcast(r.paused,a.track)}),h.addEventListener("ended",function(){e.$broadcast(r.ended,a.track),a.next()}),h.addEventListener("timeupdate",l),v.addEventListener("change",d),v.addEventListener("input",d),k.addEventListener("change",f),k.addEventListener("input",f),a.track=t.getCurrentTrack()&&t.getCurrentTrack().track,a.track&&(h.src=a.track.streamUrl),a.$on(r.playPause,function(){a.playPause()}),a.$on(r.ended,function(){a.stop()}),a.$on(o.logoutSuccess,function(){a.stop(),a.track={}}),a.$on(o.notAuthenticated,function(){a.stop()}),a.$on(r.set,function(t,r){a.track=r,h.src=r.streamUrl,a.duration=h.duration,i.isAuthenticated()?a.playPause():(e.$broadcast(o.notAuthenticated),c.addMsg("danger","Log in first to play music!"))}),a.next=function(){t.playNext()},a.prev=function(){t.playPrev()},a.playPause=function(){h.paused?h.play():h.pause(),a.playing=!h.paused&&!h.ended},a.stop=function(){h.pause(),a.playing=!1,h.currentTime=0},a.mute=function(){h.muted=!h.muted},a.muted=function(){return h.muted}},templateUrl:"/templates/zPlayer"}}]).directive("zAlbumListing",["AlbumsSvc","TracksSvc","SessionSvc","$log",function(e,t,a,r){return{restrict:"E",scope:{artist:"="},link:function(r,n,i){r.isOwner=!1,r.albums=[],r.queueUp=function(e){},r.$watch(function(){return r.artist._id},function(n){void 0!==n&&(e.getByUser({_id:n},function(e){angular.forEach(e,function(e){e.duration=0,e.trackLength=0,t.find({a_id:e._id},function(t){angular.forEach(t,function(t){e.trackLength++,duration=parseInt(t.duration),e.duration+=duration})},function(e){}),this.push(e)},r.albums)},function(e){}),a.getCurrentUser()&&n===a.getCurrentUser()._id&&(r.isOwner=!0))})},templateUrl:"/templates/zAlbumListing"}}]).directive("zTrackListing",["TracksSvc","SessionSvc","QueueSvc","$log",function(e,t,a,r){return{restrict:"E",scope:{"for":"="},link:function(r,n,i){r.isOwner=!1,r.tracks=[],r.playlists=[],r.$watch(function(){return r["for"]._id},function(a){if(void 0!==a){var n=r["for"],o=i.type="a_id",c=i.type=n.artist.id,s={};s[o]=n._id,e.find(s,function(t){angular.forEach(t,function(t){e.inflate(t._id,this,function(){},function(){})},r.tracks)},function(e){}),t.getCurrentUser()&&t.getCurrentUser()._id===c&&(r.isOwner=!0)}}),r.play=function(e){a.playNow(e)},r.addToQueue=function(e){a.addTrack(e)}},templateUrl:"/templates/zTrackListing"}}]).directive("zDetailedTrackListing",["PlaylistsSvc","QueueSvc","$log",function(e,t,a){return{restrict:"E",scope:{tracks:"=",remove:"&onRemove"},link:function(e,a,r){e.play=function(e){t.playNow(e)},e.addToQueue=function(e){t.addTrack(e)}},templateUrl:"/templates/zDetailedTrackListing"}}]).directive("zSearchBox",["PlaylistsSvc","TracksSvc","AlbumsSvc","UsersSvc",function(e,t,a,r){return{restrict:"E",link:function(n,i,o){n.playlists=n.tracks=n.albums=n.users=[],angular.isUndefined(n.searchTerm)&&(n.searchTerm=""),n.playlists=e.all,n.tracks=t.all,n.albums=a.all,n.users=r.all},templateUrl:"/templates/zSearchBox"}}]).directive("zPlaylistDropdown",["$rootScope","PlaylistsSvc","PLAYLIST_EVENTS","AUTH","AuthenticationSvc","SessionSvc","MessageSvc","$log",function(e,t,a,r,n,i,o,c){return{restrict:"E",scope:{track:"="},link:function(c,s,u){function l(){return d?void t.find({u_id:d._id},function(e){c.playlists=e},function(e){}):void(c.playlists=[])}s.addClass("z-dropdown-menu");var d=i.getCurrentUser();c.playlists=[],c.playlist={title:"",owner:{id:""}},c.loggedIn=n.isAuthenticated(),u.track&&(c.adding=!0),c.$watch(function(){return n.isAuthenticated()},function(e,t){e!==t&&(e&&(d=i.getCurrentUser()),l())}),c.$on(a.updateSuccess,function(){l()}),c.$on(a.createSuccess,function(){l()}),c.$on(a.deleteSuccess,function(){l()}),c.$on(r.loginSuccess,function(){l()}),c.loggedIn&&l(),c.create=function(r){r.owner.id=d._id,t.create(r,function(t){e.$broadcast(a.createSuccess,t),c.playlist.title=""},function(t){e.$broadcast(a.createFailed)})},c.addToPlaylist=function(e,a,r){c.adding&&(e.preventDefault(),t.addTrack(a,r,function(){o.addMsg("success",r.title+" added to "+a.title)},function(){o.addMsg("danger","Something went wrong adding track to playlist!")}))}},templateUrl:"/templates/zPlaylistDropdown"}}]).directive("zImgCrop",function(){return{restrict:"E",scope:{onImgReady:"&"},link:function(e){e.rawImage=e.croppedImage="",e.cropPending=!1,e.readFile=function(t){var a=t.files[0],r=new FileReader;r.onload=function(){e.$apply(function(){e.rawImage=r.result,e.cropPending=!0})},r.readAsDataURL(a)},e.updateAvatar=function(a){var r={file:t(a),url:a};return e.cropPending=!1,e.onImgReady({imgFile:r})};var t=function(e){for(var t=atob(e.split(",")[1]),a=e.split(",")[0].split(":")[1].split(";")[0],r=[],n=0;n<t.length;n++)r.push(t.charCodeAt(n));return new Blob([new Uint8Array(r)],{type:a})}},templateUrl:"/templates/zImgCrop"}}).directive("zMessageBox",["$rootScope","MessageSvc","$timeout",function(e,t,a){return{restrict:"E",link:function(e,a,r){e.$watch(function(){return t.getMsg()},function(t,r){t&&(e.message=t,a.show(),e.icon="success"===e.message.type?"fa fa-check":"fa fa-exclamation",timeout(function(){a.hide()},5e3))})},templateUrl:"/template/zMessageBox"}}]).directive("zAlbumCreator",["$rootScope","$document","AlbumsSvc","SessionSvc","ALBUM_EVENTS",function(e,t,a,r,n){return{restrict:"E",scope:{album:"="},link:function(t,i,o){t.save=function(t){t.artistId||(t.artist={},t.artist.id=r.getCurrentUser()._id),t.releaseDate=new Date,a.create(t,function(t){e.$broadcast(n.createSuccess,t)},function(t){e.$broadcast(n.createFailed)})}},templateUrl:"/templates/zAlbumCreator"}}]),app.factory("Users",["$resource",function(e){return e("/api/users/:id",{id:"@_id"},{update:{method:"PUT",transformRequest:FileDataObject,headers:{"Content-Type":void 0,enctype:"multipart/form-data"}},find:{method:"GET",url:"api/users/handle/:handle",params:{handle:"@handle"},isArray:!1},resetPassword:{method:"GET",url:"api/users/tokenize/:action/:email",params:{email:"@email",action:"pwd-reset"}},activate:{method:"GET",url:"api/users/tokenize/:action/:email",params:{email:"@email",action:"usr_activation"}},verifyToken:{method:"GET",url:"api/users/validate-token/:token",params:{token:"@token"}}})}]).factory("Albums",["$resource",function(e){return e("/api/albums/:id",{id:"@_id"},{update:{method:"PUT",transformRequest:FileDataObject,headers:{"Content-Type":void 0,enctype:"multipart/form-data"}},save:{method:"POST",transformRequest:FileDataObject,headers:{"Content-Type":void 0,enctype:"multipart/form-data"}},getByUser:{method:"GET",url:"/api/albums/user/:userId",params:{userId:"@_id"},isArray:!0}})}]).factory("Playlists",["$resource",function(e){return e("/api/playlists/:id",{id:"@_id"},{update:{method:"PUT"},find:{method:"GET",isArray:!0,url:"/api/playlists/:resource/:resource_id",params:{resource:"@resource",resource_id:"@resource_id"}}})}]).factory("Tracks",["$resource",function(e){return e("/api/tracks/:id",{id:"@_id"},{update:{method:"PUT",transformRequest:FileDataObject,headers:{"Content-Type":void 0,enctype:"multipart/form-data"}},save:{method:"POST",transformRequest:FileDataObject,headers:{"Content-Type":void 0,enctype:"multipart/form-data"}},find:{method:"GET",isArray:!0,url:"/api/tracks/:resource/:resource_id",params:{resource:"@resource",resource_id:"@resoureceId"}},download:{method:"GET",url:"/api/tracks/:id/download",params:{id:"@_id"}}})}]).factory("AccessToken",["$resource",function(e){return e("/zinfataclient/:resource",{resource:"@resource"},{getUser:{method:"GET",params:{resource:"me"}},getFor:{method:"POST"},revoke:{method:"POST",params:{resource:"revoke"}},refresh:{method:"POST",params:{resource:"refresh"}}})}]).factory("localStore",["$window","$rootScope","$log",function(e,t,a){return angular.element(e).on("storage",function(e){t.$apply()}),{setData:function(t,a){return e.localStorage.setItem(t,angular.toJson(a)),this},getData:function(t){var a=e.localStorage&&e.localStorage.getItem(t);return angular.fromJson(a)},deleteData:function(t){return e.localStorage&&e.localStorage.removeItem(t)}}}]).factory("sessionStore",["$window","$rootScope","$log",function(e,t,a){return{setData:function(t,a){return e.sessionStorage.setItem(t,angular.toJson(a)),this},getData:function(t){var a=e.sessionStorage&&e.sessionStorage.getItem(t);return angular.fromJson(a)},deleteData:function(t){return e.sessionStorage&&e.sessionStorage.removeItem(t)}}}]).factory("APIInterceptor",["$rootScope","$q","$location","$log","sessionStore","$httpParamSerializer","$injector",function(e,t,a,r,n,i,o){return{request:function(e){var t=n.getData("accessKeys"),a=t?t.access_token:null;return a&&(e.headers.authorization="Bearer "+a),-1!==e.url.search("zinfataclient")&&(e.headers["Content-Type"]="application/x-www-form-urlencoded",e.data=i(e.data)),e},responseError:function(e){if(401===e.status&&e.data.error&&"invalid_token"===e.data.error){var r=t.defer(),i=o.get("$http"),c=n.getData("accessKeys"),s=c?c.refresh_token:null,u={method:"POST",url:"/zinfataclient/refresh",data:{refresh_token:s}};return i(u).then(function(t){n.setData("accessKeys",t.data),i(e.config).then(function(e){r.resolve(e)},function(e){r.reject()})},function(e){r.reject(),n.deleteData("accessKeys"),n.deleteData("currentUser"),a.path("login")}),r.promise}return t.reject(e)}}}]),app.filter("duration2time",function(){return function(e){e=parseInt(e),angular.isNumber(e)||(e=0);var t="0"+Math.floor(e/60),a="0"+Math.floor(e)%60;return t.substr(-2)+":"+a.substr(-2)}}),app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,a){e.when("/",{templateUrl:"/partials/dashboard",controller:"dashboardCtrl"}).when("/register",{templateUrl:"/partials/registration",controller:"registerCtrl"}).when("/register/activate",{templateUrl:"/partials/tokenValidator",controller:"tokenCtrl"}).when("/login",{templateUrl:"/partials/login",controller:"loginCtrl"}).when("/forgot",{templateUrl:"/partials/forgot",controller:"forgotCtrl"}).when("/reset",{templateUrl:"/partials/passwordReset",controller:"passwordResetCtrl"}).when("/user/:userId",{templateUrl:"/partials/userProfile",controller:"userProfileCtrl",access:{loginRequired:!0}}).when("/user/:userId/edit",{templateUrl:"/partials/userProfile",controller:"userProfileCtrl",access:{loginRequired:!0}}).when("/album/new",{templateUrl:"/partials/album",controller:"albumCtrl",access:{loginRequired:!0}}).when("/album/:albumId",{templateUrl:"/partials/album",controller:"albumCtrl",access:{loginRequired:!0}}).when("/album/:albumId/edit",{templateUrl:"/partials/album",controller:"albumCtrl",access:{loginRequired:!0}}).when("/track/new",{templateUrl:"/partials/track",controller:"trackCtrl",access:{loginRequired:!0}}).when("/track/:trackId",{templateUrl:"/partials/track",controller:"trackCtrl",access:{loginRequired:!0}}).when("/track/:trackId/edit",{templateUrl:"/partials/track",controller:"trackCtrl",access:{loginRequired:!0}}).when("/playlist/new",{templateUrl:"/partials/playlist",controller:"playlistCtrl",access:{loginRequired:!0}}).when("/playlist/:playlistId",{templateUrl:"/partials/playlist",controller:"playlistCtrl",access:{loginRequired:!0}}).when("/playlist/:playlistId/edit",{templateUrl:"/partials/playlist",controller:"playlistCtrl",access:{loginRequired:!0}}).when("/queue",{templateUrl:"/partials/queue",controller:"queueCtrl",access:{loginRequired:!0}}).when("/search",{templateUrl:"/partials/search",controller:"searchCtrl",access:{loginRequired:!0}}).otherwise({redirectTo:"/"}),t.html5Mode(!0),a.interceptors.push("APIInterceptor")}]).run(["$rootScope","$location","$log","AuthenticationSvc","AUTH","MessageSvc","UsersSvc",function(e,t,a,r,n,i,o){var c;e.$on("$routeChangeStart",function(e,a){var o;"/register"===a.originalPath?c=null:c&&"/login"!==a.originalPath&&(t.path(c).replace(),c=null),a.access&&(o=r.authorize(a.access.loginRequired),o===n.mustLogIn?(c=t.url(),i.addMsg("warning","You must log-in first to access that resource."),t.path("login")):o===n.notAuthorized)})}]),app.service("SessionSvc",["$rootScope","AUTH","UsersSvc","sessionStore",function(e,t,a,r){var n=this,i=null;e.$on(t.loginSuccess,function(e,t){n.setCurrentUser(t)}),e.$on(t.logoutSuccess,function(){n.destroy()}),n.setCurrentUser=function(e){r.setData("currentUser",e)},n.getCurrentUser=function(){return i=r.getData("currentUser")},n.destroy=function(){n.currentUser=null,r.deleteData("currentUser"),r.deleteData("accessKeys")}}]),app.service("AuthenticationSvc",["$rootScope","AUTH","ROUTES","SessionSvc","sessionStore","AccessToken","$log",function(e,t,a,r,n,i,o){var c=this;c.login=function(a,o,c){i.getFor({username:a.handle,password:a.password},function(a){e.$broadcast(t.authenticated),i.getUser({token:a.access_token},function(i){i.activated?(r.setCurrentUser(i),n.setData("accessKeys",a),e.$broadcast(t.loginSuccess,i),o(i)):(e.$broadcast(t.mustActivateAccount,i),c("mustActivateAccount"))},function(a){e.$broadcast(t.loginFailed),c(a)})},function(a){e.$broadcast(t.notAuthenticated),c(a)})},c.logout=function(e){var t=n.getData("accessKeys"),a=t?t.refresh_token:null;i.revoke({token_type_hint:"refresh_token",token:a},function(){r.destroy(),e(!0)},function(t){"invalid token"===t.error_description&&(r.destroy(),e(!0))}),e(!1)},c.isAuthenticated=function(){return r.getCurrentUser()&&r.getCurrentUser()._id?(e.$broadcast(t.authenticated),!0):(e.$broadcast(t.notAuthenticated),!1)},c.authorize=function(e){var a=t.authorized,r=c.isAuthenticated();return e&&!r&&(a=t.mustLogIn),a}}]),app.service("UsersSvc",["Users","MessageSvc","$log","$location","$rootScope",function(e,t,a,r,n){var i=this;i.create=function(t,a,r){var n=new e;for(var i in t)n[i]=t[i];n.$save(function(e){a(e)},function(e){r(e)})},i["delete"]=function(t,a,r){e["delete"]({id:t._id},function(e){return a(e)},function(e){return r(e)})},i.update=function(t,r,n){e.get({id:t._id},function(e){for(var i in e)t[i]&&e[i]!==t[i]&&(e[i]=t[i]);t.avatar&&(e.avatar=t.avatar,delete e.avatarUrl),t.facebook&&(e.facebook=t.facebook),t.bio&&(e.bio=t.bio),t.twitter&&(e.twitter=t.twitter),t.website&&(e.website=t.website),e.$update(function(e){return r(e)},function(e){return a.error("Profile update failed: "+e),n(e)})})},i.get=function(t,a,r){e.get({id:t},function(e){e.avatarUrl&&-1===e.avatarUrl.search("user-avatar-placeholder")&&(e.avatarUrl="../../"+e.avatarUrl.split("/").slice(1).join("/")),a(e)},function(e){r(e)})},i.all=e.query(function(e){var t=[];return angular.forEach(e,function(e){e.avatarUrl&&-1===e.avatarUrl.search("user-avatar-placeholder")&&(e.avatarUrl="../../"+e.avatarUrl.split("/").slice(1).join("/")),this.push(e)},t),t},function(e){a.debug("Unable to get all the users!")}),i.findByHandle=function(t,a,r){return e.find({handle:t},function(e){a(e)},function(e){r(e)})}}]),app.service("AlbumsSvc",["Albums","$log",function(e,t){var a=this;a.create=function(t,a,r){var n=new e({about:t.about,artistId:t.artist.id,coverArt:t.coverArt,releaseDate:t.releaseDate,title:t.title});n.$save(function(e){a(e)},function(e){r(e)})},a.update=function(t,a,r){e.get({id:t._id},function(e){for(var n in e)t[n]&&e[n]!==t[n]&&(e[n]=t[n]);t.coverArt&&(e.coverArt=t.coverArt),e.$update(function(e){a(e)},function(e){r(e)})})},a.get=function(t,a,r){e.get({id:t},function(e){e.artist={id:e.artistId},delete e.artistId,e.releaseDate=new Date(e.releaseDate),e.imageUrl&&-1===e.imageUrl.search("album-coverart-placeholder")&&(e.imageUrl="../../"+e.imageUrl.split("/").slice(1).join("/")),a(e)},function(e){r(e)})},a.all=e.query(function(e){var t=[];return angular.forEach(e,function(e){e.artist={id:e.artistId},delete e.artistId,e.releaseDate=new Date(e.releaseDate),e.imageUrl&&-1===e.imageUrl.search("album-coverart-placeholder")&&(e.imageUrl="../../"+e.imageUrl.split("/").slice(1).join("/")),this.push(e)},t),t},function(e){t.debug("Unable to get all the albums!")}),a.getByUser=function(t,a,r){e.getByUser({userId:t._id},function(e){angular.forEach(e,function(e){e.artist={id:e.artistId},delete e.artistId,e.releaseDate=new Date(e.releaseDate),e.imageUrl&&-1===e.imageUrl.search("album-coverart-placeholder")&&(e.imageUrl="../../"+e.imageUrl.split("/").slice(1).join("/"))}),a(e)},function(e){r(e)})},a["delete"]=function(t,a,r){e["delete"]({id:t._id},function(e){a(e)},function(e){r(e)})}}]),app.service("TracksSvc",["Tracks","$log","UsersSvc","AlbumsSvc","$window","sessionStore",function(e,t,a,r,n,i){var o=this;o.create=function(t,a,r){var n=new e({about:t.about,albumId:t.album.id,artistId:t.artist.id,audioFile:t.audioFile,coverArt:t.coverArt,downloadable:t.downloadable,duration:t.duration,feat:t.feat,genre:t.genre,imageFile:t.imageFile,lyrics:t.lyrics,releaseDate:t.releaseDate,streamUrl:t.streamUrl,title:t.title});n.$save(function(e){a(e)},function(e){r(e)})},o.update=function(t,a,r){e.get({id:t._id},function(e){for(var n in e)t[n]&&e[n]!==t[n]&&(e[n]=t[n]);e.albumId=t.album.id,"imageFile"in t&&t.imageFile&&(e.imageFile=t.imageFile),"audioFile"in t&&t.audioFile&&(e.audioFile=t.audioFile),e.$update(function(e){a(e)},function(e){r(e)})})},o.get=function(t,a,r){e.get({id:t},function(e){e.artist={id:e.artistId},e.album={id:e.albumId},e.releaseDate=new Date(e.releaseDate),delete e.artistId,delete e.albumId,e.coverArt&&-1===e.coverArt.search("track-coverart-placeholder")&&(e.coverArt="../../"+e.coverArt.split("/").slice(1).join("/")),e.streamUrl&&(e.streamUrl="../../"+e.streamUrl.split("/").slice(1).join("/")),a(e)},function(e){r(e)})},o.latest=function(n,i){e.query(function(e){var i=[];angular.forEach(e,function(e){e.artist={id:e.artistId},e.album={id:e.albumId},e.releaseDate=new Date(e.releaseDate),delete e.artistId,delete e.albumId,a.get(e.artist.id,function(t){e.artist.handle=t.handle},function(e){t.error("Error inflating track artist info: "+e)}),r.get(e.album.id,function(t){e.album.title=t.title},function(e){t.error("Error inflating track album info: "+e)}),"coverArt"in e&&e.coverArt&&-1===e.coverArt.search("track-coverart-placeholder")&&(e.coverArt="../../"+e.coverArt.split("/").slice(1).join("/")),"streamUrl"in e&&e.streamUrl&&(e.streamUrl="../../"+e.streamUrl.split("/").slice(1).join("/")),this.push(e)},i),n(i)},function(e){i("Could query all the tracks!")})},o.find=function(t,a,r){var n;("a_id"in t||"u_id"in t)&&(n=t.a_id?{resource:"album",resource_id:t.a_id}:{resource:"artist",resource_id:params.u_id}),n?e.find(n,function(e){angular.forEach(e,function(e){e.artist={id:e.artistId},e.album={id:e.albumId},e.releaseDate=new Date(e.releaseDate),e.coverArt&&-1===e.coverArt.search("track-coverart-placeholder")&&(e.coverArt="../../"+e.coverArt.split("/").slice(1).join("/")),e.streamUrl&&(e.streamUrl="../../"+e.streamUrl.split("/").slice(1).join("/"))}),a(e)},function(e){r(e)}):r("invalid find params")},o.inflate=function(e,n,i,c){return e?void o.get(e,function(e){a.get(e.artist.id,function(t){e.artist.handle=t.handle},function(e){t.error("Error inflating track artist info: "+e)}),r.get(e.album.id,function(t){e.album.title=t.title},function(e){t.error("Error inflating track album info: "+e)}),n&&n.push(e),i(e)},function(e){c(e)}):t.debug("there is no index sent to Tracks.inflate.")},o.downloadLink=function(e,t,a){var r=i.getData("accessKeys"),o=r?r.access_token:null,c="/zinfataclient/tracks/"+e._id+"/download";o&&(c+="?token="+o,n.open(c))},o["delete"]=function(t,a,r){e["delete"]({id:t._id},function(e){e.artist={id:e.artistId},e.album={id:e.albumId},e.releaseDate=new Date(e.releaseDate),delete e.artistId,delete e.albumId,a(e)},function(e){r(e)})}}]),app.service("PlaylistsSvc",["Playlists","$log",function(e,t){var a=this;a.create=function(t,a,r){var n=new e({ownerId:t.owner.id,title:t.title,tracks:t.tracks});n.$save(function(e){return a(e)},function(e){return r(e)})},a.update=function(t,a,r){e.get({id:t._id},function(e){for(var n in e)t[n]&&e[n]!==t[n]&&(e[n]=t[n]);e.$update(function(e){return a(e)},function(e){return r(e)})})},a.get=function(t,a,r){return e.get({id:t},function(e){e.owner={id:e.ownerId},delete e.ownerId,a(e)},function(e){r(e)})},a.all=e.query(function(e){var t=[];return angular.forEach(e,function(e){e.owner={id:e.ownerId},delete e.ownerId,this.push(e)},t),t},function(e){t.debug("Unable to get all the playlists!")}),a.find=function(t,a,r){"u_id"in t&&(t.resource="owner",t.resource_id=t.u_id,delete t.u_id,e.find(t,function(e){angular.forEach(e,function(e){e.owner={id:e.ownerId},delete e.ownerId}),a(e)},function(e){r(e)}))},a["delete"]=function(t,a,r){e["delete"]({id:t._id},function(e){e.owner={id:e.ownerId},delete e.ownerId,a(e)},function(e){r(e)})},a.addTrack=function(t,a,r,n){e.get({id:t._id},function(e){e.tracks.push(a._id),e.$update(function(e){r(e)},function(e){n(!1)})},function(e){n(!1)})},a.removeTrack=function(t,a,r,n){e.get({id:t._id},function(e){e.tracks.splice(a,1),e.$update(function(e){r(e)},function(e){n(!1)})},function(e){n(!1)})}}]),app.service("QueueSvc",["localStore","$rootScope","AUDIO","QUEUE","$log","TracksSvc","SessionSvc","AUTH",function(e,t,a,r,n,i,o,c){var s=this,u=function(){return o.getCurrentUser()&&o.getCurrentUser()._id};s.playNext=function(){var e=s.getTracks(),t=s.getCurrentTrack(),a=e.length,r=t.index+1;r>=a&&(r=0),s.getTrackAt(r,function(e){s.play(e,r)})},s.playPrev=function(){var e=s.getTracks(),t=e.length,a=s.getCurrentTrack().index,r=a-1;0>r&&(r=t-1),s.getTrackAt(r,function(e){s.play(e,r)})},s.saveQueue=function(t,a){t&&Array.isArray(t)&&e.setData(u()+".queue.tracks",t),a&&e.setData(u()+".queue.nowPlaying",a)},s.clearQueue=function(){s.saveQueue([])},s.getCurrentTrack=function(){return e.getData(u()+".queue.nowPlaying")||{}},s.addTrack=function(e,t){var a=s.getTracks();t?a.unshift(e._id):a.push(e._id),s.saveQueue(a)},s.getTracks=function(){return e.getData(u()+".queue.tracks")||[]},s.getTrackAt=function(e,t,a){var r=s.getTracks();r.length?i.inflate(r[e],null,function(e){t(e)},function(e){a(e)}):a("No tracks to fetch")},s.removeTrackAt=function(e,t,a){var r=s.getTracks(),n=s.getCurrentTrack();r.splice(e,1).length?(n.index>e?n.index--:n.index===e&&(e>=r.length&&(e=0),s.getTrackAt(e,function(t){s.play(t,e)},function(){})),s.saveQueue(r,n),t(e)):a("Track removal from queue failed at index: "+e)},s.playNow=function(e){var t=0,a=0,r=s.getCurrentTrack(),n=s.getTracks();r&&(a=r.index),n.length&&Object.keys(r).length?(n.splice(a,0,e._id),t=a++):n.length&&!Object.keys(r).length?s.addTrack(e,!0):s.addTrack(e),s.play(e,t)},s.play=function(e,r){"title"in e.album||"handle"in e.artist||(e=i.inflate(e._id,null,function(e){return e},function(e){})),n.debug(e.artist.handle+" : "+e.album.title);var o=s.getCurrentTrack();o.index=r,o.track=e,s.saveQueue(null,o),t.$broadcast(a.set,o.track)}}]),app.service("MessageSvc",function(){this.message=null,this.getMsg=function(){return this.message},this.addMsg=function(e,t){this.message={type:e,text:t}},this.clear=function(){this.message=null}}),dispatch.factory("Credentials",["$resource",function(e){return e("/creds/:api",{api:"@api"},{soundcloud:{method:"GET",params:{api:"soundcloud"}}})}]).factory("Soundcloud",["$resource","$rootScope","Credentials","$log","$q","sessionStore",function(e,t,a,r,n,i){var o={},c=e("https://api.soundcloud.com/:endpoint",{endpoint:"@endpoint"},{connect:{method:"POST",params:{endpoint:"oauth2/token"}},upload:{method:"POST",params:{endpoint:"tracks"}}});return o.connect=function(e,t){a.soundcloud(function(a){var r={client_id:a.clientId,client_secret:a.clientSecret,grant_type:"password",username:a.username,password:a.password};c.connect(r,function(t){e(t)},function(e){t(e)})})},o.upload=function(e){({title:e.artist.handle+" - "+e.title,asset_data:e.audioFile})},o}]),app.controller("albumCtrl",["$scope","$rootScope","$location","$routeParams","SessionSvc","TracksSvc","QueueSvc","AlbumsSvc","UsersSvc","MessageSvc","ALBUM_EVENTS","$log",function(e,t,a,r,n,i,o,c,s,u,l,d){e.album={coverArt:"",imageUrl:"images/album-coverart-placeholder.png",title:"",artist:{id:""},about:"",releaseDate:""},e.editing=!1,e.creating=!1,e.canEdit=!1,e.pageTitle="Add New Album",e.pageDescription="Quickly upload a new album to Zinfata.","/album/new"===a.path()&&(e.creating=!0),r.albumId&&c.get(r.albumId,function(t){e.album=t,e.album.duration=0,e.album.trackLength=0;var o=0;e.album.artist.id&&e.album.artist.id===n.getCurrentUser()._id&&(e.canEdit=!0),a.path()==="/album/"+r.albumId+"/edit"&&(e.canEdit?e.editing=!0:a.path("album/"+r.albumId),e.editing&&(e.pageTitle="Edit Album Info",e.pageDescription="Edit this album basic information.")),s.get(e.album.artist.id,function(t){e.album.artist.handle=t.handle,e.album.artist.avatarUrl=t.avatarUrl},function(t){e.album.artist="Unknown"}),i.find({a_id:t._id},function(t){angular.forEach(t,function(t){e.album.trackLength++,o=parseInt(t.duration),angular.isNumber(o)&&(e.album.duration+=o)})},function(e){})},function(e){a.path("/")}),e.edit=function(e){a.path("/album/"+e._id+"/edit")},e.queueUp=function(e){},e.play=function(e){},e.create=function(e){e.artist.id||(e.artist.id=n.getCurrentUser()._id),c.create(e,function(e){t.$broadcast(l.createSuccess),u.addMsg("success","You have successfully added a new album!"),a.path("album/"+e._id)},function(e){t.$broadcast(l.createFailed),u.addMsg("danger","Something went wrong trying to create your album!")})},e.update=function(r){e.album.duration&&delete e.album.duration,e.album.trackLength&&delete e.album.trackLength,r.artist.id||(r.artist.id=n.getCurrentUser()._id),c.update(r,function(r){t.$broadcast(l.updateSuccess),u.addMsg("success","You have successfully updated the album info"),e.editing=!1,a.path("album/"+r._id)},function(e){t.$broadcast(l.updateFailed),u.addMsg("danger","Something went wrong trying to update your album!")})},e["delete"]=function(e){c["delete"](e,function(){u.addMsg("success","The album has been successfully deleted!"),t.$broadcast(l.deleteSuccess),a.path("/user/"+e.artist.id)},function(e){u.addMsg("danger","A problem prevented the deletion of your album. Try again later"),t.$broadcast(l.deleteFailed)})},e.updateCoverImage=function(t){e.album.coverArt=t.file,e.album.imageUrl=t.url}}]),app.controller("dashboardCtrl",["$scope","TracksSvc","SessionSvc","$log","QueueSvc",function(e,t,a,r,n){e.tracks=[],e.loggedIn=function(){return!!a.getCurrentUser()},t.latest(function(t){e.tracks=t},function(e){r.debug(e)}),e.play=function(e){n.playNow(e)},e.addToQueue=function(e){n.addTrack(e)}}]),app.controller("forgotCtrl",["$scope","$rootScope","$location","MessageSvc","Users","PWD_TOKEN",function(e,t,a,r,n,i){e.email="",e.reset=function(a){n.resetPassword({email:a},function(a){t.$broadcast("PWD_TOKEN.sendSuccess"),r.addMsg("success","An email has been sent to you withinstructions on how to reset your password"),e.email=""},function(e){t.$broadcast("PWD_TOKEN.sendFailed"),r.addMsg("danger","Something went wrong when trying toverify your email. Try again later!")})}}]),app.controller("loginCtrl",["$scope","$rootScope","AUTH","AuthenticationSvc","MessageSvc","$location","$log",function(e,t,a,r,n,i,o){e.credentials={handle:"",password:""},e.authenticate=function(t){r.login(t,function(t){n.addMsg("success","You are now logged in as "+t.handle),
e.credentials={},e.loginForm.$setPristine(),i.path("dashboard")},function(e){var t;"mustActivateAccount"===e?(t="You must activate your account to access all the music.Check the email we sent you for the activation link.Or enter your email address below to have us send you a new validation link.",i.path("register/activate")):(t="Login failed! Try again later.",i.path("login")),n.addMsg("danger",t)})}}]),app.controller("logoutCtrl",["$rootScope","$log","MessageSvc","UsersSvc","AUTH",function(e,t,a,r,n){Auth.logout(function(){r.setCurrentUser({}),e.$broadcast(n.logoutSuccess),a.addMsg("success","You have been successfully logged out!")},function(e){a.addMsg("danger","We couldn't log you out. Try again later!")})}]),app.controller("passwordResetCtrl",["$scope","$log","$rootScope","UsersSvc","Users","$location","MessageSvc","USER_EVENTS","PWD_TOKEN","$routeParams",function(e,t,a,r,n,i,o,c,s,u){e.credentials={password:"",passwordConfirmation:"",token:""},e.validated=!1,e.verify=function(t){n.verifyToken({token:t},function(t){a.$broadcast(s.verificationSuccess),e.validated=!0},function(e){a.$broadcast(s.verificationFailed),o.addMsg("danger","The verification token is either invalid or expired. Request a new one!")})},e.update=function(e){e.token&&e.password===e.passwordConfirmation&&n.verifyToken({token:e.token,get_user:!0},function(n){r.update({password:e.password,_id:n.userId},function(e){t.debug(angular.toJson(e)),a.$broadcast(c.updateSuccess),o.addMsg("success","Password successfully updated. Log in now"),i.path("login")},function(e){a.$broadcast(c.updateFailed),o.addMsg("danger","Something went wrong when trying to update your password!")})})},u.token&&(e.credentials.token=u.token,e.verify(e.credentials.token))}]),app.controller("playlistCtrl",["$scope","$rootScope","$location","$log","$routeParams","AlbumsSvc","TracksSvc","UsersSvc","SessionSvc","PlaylistsSvc","MessageSvc","QueueSvc","PLAYLIST_EVENTS",function(e,t,a,r,n,i,o,c,s,u,l,d,f){e.playlist={title:"",owner:{id:"",handle:""},tracks:[]},e.playlistTracks=[],e.canEdit=!1,e.creating=!1,e.editing=!1,e.pageTitle="Add New Playlist",e.pageDescription="Find and share your favorite tracks easily.","/playlist/new"===a.path()&&(e.creating=!0),n.playlistId&&u.get(n.playlistId,function(t){if(t.duration=0,t.owner.id&&t.owner.id===s.getCurrentUser()._id&&(e.canEdit=!0),a.path()==="/playlist/"+n.playlistId+"/edit"&&(e.canEdit?e.editing=!0:a.path("/playlist/"+n.playlistId),e.editing&&(e.pageDescription="Change this playlist's information",e.pageTitle="Update Playlist")),c.get(t.owner.id,function(e){t.owner.handle=e.handle},function(e){r.error("Error getting playlist owner info: "+e)}),t.tracks.length){var i=0;angular.forEach(t.tracks,function(a,r){"string"==typeof a&&o.inflate(a,e.playlistTracks,function(e){i=parseInt(e.duration),angular.isNumber(i)||(i=0),t.duration+=i},function(e){})})}e.playlist=t},function(e){a.path("/")}),e.edit=function(){a.path("/playlist/"+e.playlist._id+"/edit")},e.removeTrack=function(a){u.removeTrack(e.playlist,a,function(t){e.playlistTracks.splice(a,1)},function(e){t.$broadcast(f.updateFailed)})},e.play=function(e){d.playNow(e)},e.addToQueue=function(e){d.addTrack(e)},e.create=function(e){e.owner.id=s.getCurrentUser()._id,u.create(e,function(e){t.$broadcast(f.createSuccess),l.addMsg("success","You have successfully added a new playlist!"),a.path("playlist/"+e._id)},function(e){t.$broadcast(f.createFailed),l.addMsg("danger","Something went wrong trying to add your new playlist!")})},e.update=function(e){u.update(e,function(e){t.$broadcast(f.updateSuccess),l.addMsg("success","You have successfully updated this playlist!"),a.path("playlist/"+e._id)},function(e){t.$broadcast(f.updateFailed),l.addMsg("danger","Something went wrong trying to update your playlist!")})},e["delete"]=function(e){u["delete"](e,function(e){t.$broadcast(f.deleteSuccess),l.addMsg("success","You have successfully deleted the playlist!"),a.path("/")},function(e){t.$broadcast(f.deleteFailed),l.addMsg("danger","Something went wrong trying to delete your playlist!")})}}]),app.controller("queueCtrl",["$scope","$rootScope","$log","QueueSvc","TracksSvc","UsersSvc","AlbumsSvc","AUDIO",function(e,t,a,r,n,i,o,c){var s=r.getTracks(),u=0;e.queueTracks=[],e.nowLoaded=r.getCurrentTrack()&&r.getCurrentTrack().index,e.queueDuration=0,s.length&&angular.forEach(s,function(t,a){"string"==typeof t&&n.inflate(t,this,function(t){u=parseInt(t.duration),angular.isNumber(u)||(u=0),e.queueDuration+=u},function(e){})},e.queueTracks),e.$on(c.set,function(){e.nowLoaded=r.getCurrentTrack()&&r.getCurrentTrack().index}),e.$watch(function(){return e.queueTracks.length},function(t,a){t!==a&&(e.queueDuration=0,angular.forEach(e.queueTracks,function(t){u=parseInt(t.duration),angular.isNumber(u)||(u=0),e.queueDuration+=u}))}),e.playPause=function(a,n){a.preventDefault(),e.nowLoaded===n?t.$broadcast(c.playPause):(r.play(e.queueTracks[n],n),e.nowLoaded=n)},e.removeTrack=function(t){r.removeTrackAt(t,function(){e.queueTracks.splice(t,1),e.nowLoaded>=t&&(e.nowLoaded=r.getCurrentTrack()&&r.getCurrentTrack().index)},function(e){a.error(e)})}}]),app.controller("registerCtrl",["$scope","UsersSvc","MessageSvc","$location",function(e,t,a,r){e.user={firstName:"",lastName:"",handle:"",email:"",password:""},e.register=function(){t.create(e.user,function(t){a.addMsg("success","Welcome to Zinfata, "+t.firstName+". Check the email we sent you to activate your account"),e.user={},e.registerForm.$setPristine()},function(e){a.addMsg("danger","Oops, we were unable to register you!")})}}]),app.controller("searchCtrl",["$routeParams",function(e){"q"in e&&(scope.searchTerm=e.q)}]),app.controller("tokenCtrl",["$scope","$rootScope","$routeParams","$location","Users","MessageSvc","PWD_TOKEN","USER_EVENTS",function(e,t,a,r,n,i,o,c){var s=a.token;e.email="",s&&n.verifyToken({token:s},function(e){t.$broadcast(c.accountActivated),i.addMsg("success","Account successfully activated. Log in now to access all the music!"),r.path("login")},function(e){t.$broadcast(o.verificationFailed),i.addMsg("danger","That activation link is no longer valid. Please, request a new one!")}),e.activate=function(e){n.activate({email:e},function(e){t.$broadcast(o.sendSuccess),i.addMsg("success","Great. We just sent you a new email with the link to activate your account!")},function(e){t.$broadcast(o.sendFailed),i.addMsg("danger","We couldn't send you a new email at the moment. Try again later.")})}}]),app.controller("trackCtrl",["$scope","$sce","$rootScope","$location","$routeParams","$log","UsersSvc","SessionSvc","TracksSvc","PlaylistsSvc","TRACK_EVENTS","AlbumsSvc","ALBUM_EVENTS","MessageSvc","QueueSvc",function(e,t,a,r,n,i,o,c,s,u,l,d,f,p,g){var m="",h={},v={},k=function(t){d.getByUser({_id:t},function(t){t.length&&(e.track.album.id||(e.track.album.title=t[0].title,e.track.album.releaseDate=t[0].releaseDate,e.track.album.id=t[0]._id,e.track.coverArt=t[0].imageUrl),angular.forEach(t,function(t){h[t._id]=t.imageUrl,v[t._id]=t.releaseDate,t._id===e.track.album.id&&(e.track.album.title=t.title,e.track.album.releaseDate=t.releaseDate,e.track.coverArt!==t.imageUrl&&(e.cover.unique=!0,m=e.track.coverArt))}),e.albums=t)},function(t){i.error("Error fetching albums for artist: "+e.track.artist.id)})};e.musicGenres=["alternative","blues","danse","hip hop","rap","r&b","soul","jazz","gospel","reggae","rock","dubstep","trap","instrumental","salsa","flamenco","reggaeton","meditation","funk","dancehall","a cappella","afro-beat","calypso","coupe-decale","worldbeat"],e.track={title:"",about:"",lyrics:"",album:{id:null,title:"",coverArt:""},artist:{id:null,handle:""},streamUrl:"",coverArt:"images/track-coverart-placeholder.png",duration:"",releaseDate:"",genre:"",downloadable:!1},e.cover={unique:!1},e.albums=[],e.creating=e.editing=!1,e.pageTitle="Add New Track",e.pageDescription="Upload a new song for the world to enjoy.","/track/new"===r.path()&&(e.creating=!0),n.trackId&&s.get(n.trackId,function(a){e.track=a,e.track.streamUrl=t.trustAsResourceUrl(a.streamUrl),e.track.artist.id&&e.track.artist.id===c.getCurrentUser()._id&&(e.canEdit=!0),r.path()==="/track/"+n.trackId+"/edit"&&(e.canEdit?e.editing=!0:r.path("track/"+n.trackId),e.editing&&(e.pageDescription="Edit this track's information",e.pageTitle="Edit Track Information")),k(e.track.artist.id),o.get(e.track.artist.id,function(t){e.track.artist.handle=t.handle},function(t){i.error("could not fetch track artist: "+e.track.artist.id)})},function(e){r.path("/")}),e.creating&&(k(c.getCurrentUser()._id),-1!==e.track.coverArt.search("track-coverart-placeholder")&&(e.cover.unique=!0)),e.$watch(function(){return e.track.album.id},function(t,a){t!==a&&(!e.cover.unique&&h[t]&&(e.track.coverArt=h[t]),e.track.album.releaseDate=v[t],(!e.track.releaseDate||e.track.album.releaseDate<e.track.releaseDate)&&(e.track.releaseDate=e.track.album.releaseDate))}),e.$watch(function(){return e.track.streamUrl},function(t,a){var r=new Audio(t);r.onloadedmetadata=function(){e.track.duration=r.duration}}),e.$watch(function(){return e.track.coverArt},function(t){-1!==t.search("album-coverart-placeholder")&&(e.track.coverArt=t.replace("album","track"))}),e.$on(f.createSuccess,function(t,a){e.albums.push(a),e.track.album.id||(v[a._id]=new Date(a.releaseDate),e.track.album.id=a._id,e.track.album.title=a.title)}),e.readFile=function(a){var r=a.files[0],n=new FileReader;n.onload=function(){e.$apply(function(){"music"===a.name&&(e.track.audioFile=r,e.track.streamUrl=t.trustAsResourceUrl(n.result))})},n.readAsDataURL(r)},e.getFile=function(t){e.track.audioFile=t.files[0]},e.addToPlaylist=function(t){u.addTrack(t,e.track)},e.play=function(e){g.playNow(e)},e.addToQueue=function(e){g.addTrack(e)},e.create=function(e){e.artist.id=c.getCurrentUser()._id,delete e.streamUrl,s.create(e,function(e){a.$broadcast(l.createSuccess,e),p.addMsg("success","You have successfully added a new track!"),r.path("track/"+e._id)},function(e){a.$broadcast(l.createFailed,e),p.addMsg("danger","Something went wrong trying to upload your new track!")})},e.update=function(e){delete e.streamUrl,s.update(e,function(e){a.$broadcast(l.updateSuccess,e),p.addMsg("success","You have successfully updated this track!"),r.path("track/"+e._id)},function(e){a.$broadcast(l.updateFailed,e),p.addMsg("danger","Something went wrong trying to update your track's info!")})},e["delete"]=function(e){s["delete"](e,function(e){a.$broadcast(l.deleteSuccess),p.addMsg("success","You have successfully deleted the track!"),r.path("/album/"+e.album.id)},function(e){a.$broadcast(l.deleteFailed),p.addMsg("danger","Something went wrong trying to delete your track!")})},e.updateCoverArt=function(t){t?e.track.coverArt=m:e.track.coverArt=h[e.track.album.id]},e.updateCoverImage=function(t){e.track.imageFile=t.file,e.track.coverArt=m=t.url},e.download=function(e){s.downloadLink(e,function(e){a.$broadcast(l.downloadSuccess)},function(){a.$broadcast(l.downloadFailed),p.addMsg("danger","Download failed!")})},e.edit=function(){r.path("/track/"+e.track._id+"/edit")}}]),app.controller("userProfileCtrl",["$scope","$rootScope","UsersSvc","AlbumsSvc","MessageSvc","USER_EVENTS","$routeParams","$log","$location","SessionSvc",function(e,t,a,r,n,i,o,c,s,u){var l=o.userId||u.getCurrentUser()&&Sesion.getCurrentUser()._id||null;e.fbRegex=/(?:https?:\/\/)?(?:www\.)?facebook\.com\/(?:(?:\w)*#!\/)?(?:pages\/)?(?:[\w\-]*\/)*([\w\-]*)/,e.user={},e.editing=!1,e.canEdit=!1,a.get(l,function(t){e.user=t,u.getCurrentUser()._id===e.user._id&&(e.canEdit=!0),s.path()==="/user/"+l+"/edit"&&e.canEdit&&(e.editing=!0)},function(e){s.path("/")}),e.fullname=function(e){return e.firstName+" "+e.lastName},e.edit=function(){s.path("/user/"+e.user._id+"/edit")},e.update=function(r){a.update(r,function(a){n.addMsg("success","Your profile has been updated!"),t.$broadcast(i.updateSuccess),e.editing=!1,s.path("/user/"+e.user._id)},function(e){n.addMsg("danger","Profile update unsuccessful!"),t.$broadcast(i.updateFailed)})},e["delete"]=function(e){a["delete"](e,function(e){n.addMsg("success","Your account has been deleted!"),t.$broadcast(i.deleteSuccess,e)},function(e){n.addMsg("danger","A problem prevented your account deletion. Try again later"),t.$broadcast(i.deleteFailed)})},e.updateAvatar=function(t){e.user.avatar=t.file,e.user.avatarUrl=t.url}}]),app.controller("headerCtrl",["$scope","$rootScope","AUTH","SessionSvc","MessageSvc","AuthenticationSvc","$location","$log","USER_EVENTS",function(e,t,a,r,n,i,o,c,s){function u(){e.loggedIn&&(e.user=r.getCurrentUser())}e.loggedIn=i.isAuthenticated,e.user=r.getCurrentUser(),e.$watch(function(){return i.isAuthenticated()},function(e,t){e!==t&&u()}),e.$on(s.deleteSuccess,function(){e.logout()}),e.userProfile=function(e){var t="#";return e&&"_id"in e&&e._id&&(t="user/"+e._id),t},e.userSettings=function(e){return"#"},e.logout=function(){i.logout(function(e){e?(n.addMsg("success","You have been successfully logged out!"),t.$broadcast(a.logoutSuccess)):(n.addMsg("danger","Issue with the logout process!"),r.destroy(),t.$broadcast(a.logoutFailed)),o.path("/login")})}}]),app.controller("messageCtrl",["$scope","MessageSvc","$log","$timeout",function(e,t,a,r){var n=angular.element(".alert-dismissable");e.icon=function(){return"success"===e.message().type?"fa fa-check":"fa fa-exclamation"},e.$watch(function(){return t.getMsg()},function(t,a){n.show(),e.message=t,e.icon=e.message&&"success"===e.message.type?"fa fa-check":"fa fa-exclamation",r(function(){n.alert("close")},3e3)}),n.on("close.bs.alert",function(){return n.hide(),!1})}]),app.controller("playerCtrl",["$scope","$rootScope",function(e,t){e.track={},e.$on("AUDIO.set",function(e){})}]),app.controller("sidebarCtrl",["$scope","$log","AuthenticationSvc","PlaylistsSvc","SessionSvc","AUTH",function(e,t,a,r,n,i){n.getCurrentUser();e.isloggedIn=a.isAuthenticated}]);